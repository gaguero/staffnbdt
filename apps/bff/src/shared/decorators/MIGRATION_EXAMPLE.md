/**\n * EXAMPLE: Migrating from @Roles to @RequirePermission\n * \n * This file shows how to migrate an existing controller from the legacy\n * @Roles system to the new flexible @RequirePermission system.\n */\n\n// BEFORE: Legacy @Roles system\nimport { Controller, Get, Post, UseGuards } from '@nestjs/common';\nimport { Roles } from '../decorators/roles.decorator';\nimport { RolesGuard } from '../guards/roles.guard';\nimport { JwtAuthGuard } from '../guards/jwt-auth.guard';\nimport { Role } from '@prisma/client';\n\n/*\n@Controller('users-legacy')\n@UseGuards(JwtAuthGuard, RolesGuard)\nexport class UsersLegacyController {\n  \n  @Get()\n  @Roles(Role.PLATFORM_ADMIN, Role.DEPARTMENT_ADMIN)\n  async findAll() {\n    // All admins can see all users - no scoping\n    return this.usersService.findAll();\n  }\n  \n  @Post()\n  @Roles(Role.PLATFORM_ADMIN)\n  async create() {\n    // Only platform admins can create users\n    return this.usersService.create();\n  }\n  \n  @Get(':id')\n  @Roles(Role.PLATFORM_ADMIN, Role.DEPARTMENT_ADMIN, Role.STAFF)\n  async findOne() {\n    // Anyone can view any user - security issue!\n    return this.usersService.findOne();\n  }\n}\n*/\n\n// AFTER: New @RequirePermission system\nimport {\n  RequirePermission,\n  PermissionScope,\n  PERMISSIONS,\n  OwnerOrPermission,\n} from '../decorators/require-permission.decorator';\nimport { PermissionGuard } from '../guards/permission.guard';\nimport { getPermissionFilters } from '../guards/permission.guard';\n\n@Controller('users-new')\n@UseGuards(JwtAuthGuard, PermissionGuard, RolesGuard) // Keep RolesGuard for backwards compatibility\nexport class UsersNewController {\n  \n  @Get()\n  @RequirePermission([\n    PERMISSIONS.USERS.READ_PLATFORM,     // Platform admin: see all users\n    PERMISSIONS.USERS.READ_ORGANIZATION, // Org admin: see org users  \n    PERMISSIONS.USERS.READ_PROPERTY,     // Property manager: see property users\n    PERMISSIONS.USERS.READ_DEPARTMENT,   // Dept admin: see department users\n  ])\n  @PermissionScope('department') // Automatically filter by scope\n  async findAll(@Request() req) {\n    // Automatic scope filtering based on user's permissions\n    const filters = getPermissionFilters(req);\n    return this.usersService.findAll(filters);\n  }\n  \n  @Post()\n  @RequirePermission([\n    PERMISSIONS.USERS.CREATE_PLATFORM,   // Platform admin: create anywhere\n    PERMISSIONS.USERS.CREATE_PROPERTY,   // Property manager: create in property\n    PERMISSIONS.USERS.CREATE_DEPARTMENT, // Dept admin: create in department\n  ])\n  async create(@Request() req, @Body() createUserDto) {\n    const filters = getPermissionFilters(req);\n    return this.usersService.create(createUserDto, filters);\n  }\n  \n  @Get(':id')\n  @OwnerOrPermission({\n    ownerField: 'id', // User can view their own profile\n    fallbackPermission: PERMISSIONS.USERS.READ_DEPARTMENT,\n    errorMessage: 'You can only view your own profile or users in your department'\n  })\n  async findOne(@Param('id') id: string, @Request() req) {\n    // Users can view their own profile OR department users if they have permission\n    return this.usersService.findOne(id, req.user);\n  }\n  \n  @Patch(':id/role')\n  @RequirePermission(PERMISSIONS.USERS.CHANGE_ROLE) // Platform admin only\n  async changeRole(@Param('id') id: string, @Body() changeRoleDto) {\n    return this.usersService.changeRole(id, changeRoleDto);\n  }\n  \n  @Delete(':id')\n  @RequirePermission([\n    PERMISSIONS.USERS.DELETE_PLATFORM,   // Platform admin: delete anyone\n    PERMISSIONS.USERS.DELETE_PROPERTY,   // Property manager: delete in property\n  ])\n  async remove(@Param('id') id: string, @Request() req) {\n    const filters = getPermissionFilters(req);\n    return this.usersService.remove(id, filters);\n  }\n}\n\n// Service layer integration\nexport class UsersService {\n  \n  async findAll(permissionFilters: any = {}) {\n    const where = {\n      deletedAt: null,\n      ...permissionFilters, // Apply permission-based filters\n    };\n    \n    return this.prisma.user.findMany({ where });\n  }\n  \n  async create(createUserDto: any, permissionFilters: any = {}) {\n    // Ensure created user respects permission boundaries\n    const userData = {\n      ...createUserDto,\n      // Inherit organizational context from creator\n      organizationId: permissionFilters.organizationId || createUserDto.organizationId,\n      propertyId: permissionFilters.propertyId || createUserDto.propertyId,\n      departmentId: permissionFilters.departmentId || createUserDto.departmentId,\n    };\n    \n    return this.prisma.user.create({ data: userData });\n  }\n  \n  async findOne(id: string, currentUser: any) {\n    // Check if user can access this specific user\n    const user = await this.prisma.user.findUnique({ where: { id } });\n    \n    if (!user) {\n      throw new NotFoundException('User not found');\n    }\n    \n    // Additional access check (already handled by guard, but good practice)\n    if (user.id !== currentUser.id && \n        user.departmentId !== currentUser.departmentId &&\n        !['PLATFORM_ADMIN', 'PROPERTY_MANAGER'].includes(currentUser.role)) {\n      throw new ForbiddenException('Access denied');\n    }\n    \n    return user;\n  }\n}\n\n/**\n * MIGRATION STEPS:\n * \n * 1. Add PermissionGuard to controllers:\n *    @UseGuards(JwtAuthGuard, PermissionGuard, RolesGuard)\n * \n * 2. Replace @Roles with @RequirePermission:\n *    - @Roles(Role.PLATFORM_ADMIN) → @RequirePermission(PERMISSIONS.RESOURCE.ACTION_PLATFORM)\n *    - @Roles(Role.DEPARTMENT_ADMIN) → @RequirePermission(PERMISSIONS.RESOURCE.ACTION_DEPARTMENT)\n * \n * 3. Add scope filtering where appropriate:\n *    @PermissionScope('department') for automatic filtering\n * \n * 4. Update services to use permission filters:\n *    const filters = getPermissionFilters(req);\n *    return this.service.findAll(filters);\n * \n * 5. Use conditional permissions for complex logic:\n *    @OwnerOrPermission for owner-based access\n *    @ConditionalPermission for custom conditions\n * \n * 6. Test thoroughly:\n *    - Verify each role can access appropriate resources\n *    - Confirm scope filtering works correctly\n *    - Test edge cases and permission boundaries\n * \n * 7. Enable new system:\n *    Set USE_PERMISSION_SYSTEM=true in environment\n * \n * 8. Remove old @Roles decorators:\n *    After confirming new system works correctly\n */\n\n/**\n * BACKWARDS COMPATIBILITY:\n * \n * During migration, both systems work together:\n * - Endpoints with @RequirePermission use the new system\n * - Endpoints with only @Roles use the legacy system  \n * - RolesGuard automatically maps roles to permissions when possible\n * \n * This allows gradual migration without breaking existing functionality.\n */